# S3超初心者向け完全ガイド - Actoryアプリケーション編

## 📚 このガイドについて

このガイドは、**技術的な知識が全くない人でも理解できる**ように、S3やバケットなどの専門用語を、日常的な例え話を使って説明します。また、ActoryアプリケーションがどのようにS3を使っているか、他のツール（Next.js、Turso、OpenAI Whisperなど）との関係も詳しく説明します。

---

## 🎯 まず最初に：S3って何？

### 簡単な例え話

**S3は、インターネット上の「巨大な倉庫」**だと思ってください。

- **あなたの家（パソコン）**: 録音ファイルを一時的に保存する場所。でも容量が限られている。
- **S3（倉庫）**: インターネット上にある、ほぼ無限の容量を持つ倉庫。世界中のどこからでもアクセスできる。

### なぜS3が必要なの？

Actoryアプリケーションで録音した音声ファイルは、**とても大きい**です。例えば：
- 1時間の会議の録音 = 約50MB（メガバイト）
- 10時間の会議の録音 = 約500MB

これを全部あなたのパソコンに保存していたら、すぐに容量が足りなくなってしまいます。だから、**S3という「倉庫」に保存する**のです。

---

## 📦 バケット（Bucket）とは？

### 簡単な例え話

**バケットは、S3倉庫の中にある「整理箱」**だと思ってください。

- **S3倉庫**: 全体の建物
- **バケット（整理箱）**: 倉庫の中にある、特定の目的のための箱

例えば：
- 「actory-recordings」というバケット = 録音ファイル専用の整理箱
- 「actory-documents」というバケット = 文書専用の整理箱（将来使うかも）

### なぜバケットが必要なの？

整理箱がないと、倉庫の中がごちゃごちゃになってしまいます。バケットを使うことで：
- **録音ファイルだけ**を1つのバケットに入れる
- **写真だけ**を別のバケットに入れる
- **文書だけ**を別のバケットに入れる

このように、**種類ごとに整理**できるのです。

---

## 🔑 アクセスキー（Access Key）とは？

### 簡単な例え話

**アクセスキーは、S3倉庫の「鍵」**だと思ってください。

- **アクセスキーID**: 倉庫の「鍵の番号」（例：AKIAIOSFODNN7EXAMPLE）
- **シークレットアクセスキー**: 倉庫の「鍵そのもの」（例：wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY）

### なぜ2つの鍵が必要なの？

**セキュリティのため**です。

1. **アクセスキーID**: これは「誰がアクセスしようとしているか」を示す番号。比較的安全に共有できる。
2. **シークレットアクセスキー**: これは「本当の鍵」。絶対に他人に知られてはいけない。

例え話で言うと：
- **アクセスキーID**: 「私は田中太郎です」という名札
- **シークレットアクセスキー**: 実際に倉庫を開けるための鍵

名札だけでは倉庫を開けられませんが、鍵だけでも「誰が開けているか」わかりません。**両方必要**なのです。

---

## 🌍 リージョン（Region）とは？

### 簡単な例え話

**リージョンは、S3倉庫の「場所」**だと思ってください。

- **東京リージョン（ap-northeast-1）**: 東京にある倉庫
- **シドニーリージョン（ap-southeast-2）**: シドニーにある倉庫
- **アメリカ東部リージョン（us-east-1）**: アメリカ東部にある倉庫

### なぜリージョンが重要なの？

**距離が近いほど、アクセスが速い**からです。

- **あなたが日本にいる場合**: 東京の倉庫を使うと、データの送受信が速い
- **あなたがオーストラリアにいる場合**: シドニーの倉庫を使うと、データの送受信が速い

Actoryアプリケーションでは、**あなたの住んでいる場所に近いリージョン**を選ぶと、録音ファイルのアップロードやダウンロードが速くなります。

---

## 🏢 AWS（Amazon Web Services）とは？

### 簡単な例え話

**AWSは、S3倉庫を運営している「会社」**だと思ってください。

- **AWS（Amazon Web Services）**: 倉庫を運営している会社
- **S3**: AWSが提供している倉庫サービスの名前

### なぜAWSを使うの？

AWSは、世界中で使われている、**信頼性の高い**サービスです。

- **99.999999999%（イレブンナイン）の耐久性**: データが失われる可能性が極めて低い
- **世界中に倉庫がある**: どこからでもアクセスできる
- **24時間365日稼働**: いつでも使える

---

## 🔐 IAM（Identity and Access Management）とは？

### 簡単な例え話

**IAMは、S3倉庫の「セキュリティ管理システム」**だと思ってください。

- **IAM**: 誰が倉庫にアクセスできるかを管理するシステム
- **IAMユーザー**: 倉庫にアクセスできる「人」のアカウント
- **IAMポリシー**: 「この人は録音ファイルをアップロードできるが、削除はできない」などのルール

### なぜIAMが必要なの？

**セキュリティのため**です。

Actoryアプリケーションは、IAMユーザーを作成して、そのユーザーに「録音ファイルをアップロードできる」という権限だけを与えます。これにより：
- **Actoryアプリケーション**: 録音ファイルをアップロードできる
- **悪意のある人**: アクセスキーを持っていないので、アクセスできない

---

## 📝 .env.localファイルとは？

### 簡単な例え話

**.env.localファイルは、Actoryアプリケーションの「設定メモ」**だと思ってください。

このファイルには、以下のような情報が書かれています：
```
S3_BUCKET_NAME=actory-recordings
S3_REGION=ap-southeast-2
S3_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
S3_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

### なぜ.env.localファイルが必要なの？

ActoryアプリケーションがS3倉庫にアクセスするためには、**「どの倉庫を使うか」「どの鍵を使うか」**を知る必要があるからです。

.env.localファイルにこれらの情報を書いておくと、Actoryアプリケーションは自動的にS3倉庫にアクセスできるようになります。

### なぜ「.local」という名前なの？

**.localは「このパソコンだけの設定」**という意味です。

- **.env.local**: あなたのパソコンだけの設定（Gitにコミットしない）
- **.env.example**: 他の人に「こんな設定が必要ですよ」と示すためのテンプレート（Gitにコミットする）

---

## 🔄 ActoryアプリケーションとS3の関係

### 録音から保存までの流れ

1. **ユーザーが録音する**
   - ブラウザ（Chrome、Safariなど）で録音を開始
   - 音声データが一時的にパソコンのメモリに保存される

2. **ActoryアプリケーションがS3にアップロード**
   - 録音が終わると、Actoryアプリケーションが音声ファイルをS3倉庫にアップロード
   - この時、.env.localファイルに書かれたアクセスキーを使って、S3倉庫にアクセス

3. **S3倉庫に保存される**
   - 音声ファイルが「actory-recordings」バケットに保存される
   - ファイルには一意のID（例：`rec_12345_20241220_143022.webm`）が付けられる

4. **Actoryアプリケーションがデータベースに記録**
   - Tursoデータベースに「この録音ファイルはS3のこの場所に保存されています」という情報を記録

5. **後でアクセスする時**
   - ユーザーが録音を再生したい時、ActoryアプリケーションはTursoデータベースからS3の場所を取得
   - S3から音声ファイルをダウンロードして、ユーザーに再生

---

## 🛠️ 他のツールとの関係

### Next.js（Actoryアプリケーションの基盤）

**Next.jsは、Actoryアプリケーションの「エンジン」**です。

- **Next.js**: アプリケーション全体を動かすフレームワーク
- **S3**: 録音ファイルを保存する場所

Next.jsは、S3にアクセスするためのコード（`src/server/actions/recording.ts`）を実行して、録音ファイルをアップロードします。

### Turso（データベース）

**Tursoは、Actoryアプリケーションの「記録帳」**です。

- **Turso**: 録音のメタデータ（タイトル、日時、S3の場所など）を保存
- **S3**: 実際の音声ファイルを保存

例え話で言うと：
- **Turso**: 「2024年12月20日の会議の録音は、S3の`rec_12345.webm`に保存されています」という記録
- **S3**: 実際の`rec_12345.webm`ファイル

### OpenAI Whisper（文字起こしAI）

**OpenAI Whisperは、録音を文字に変換する「翻訳者」**です。

- **S3**: 録音ファイルを保存
- **OpenAI Whisper**: S3から録音ファイルをダウンロードして、文字起こしを行う

流れ：
1. ActoryアプリケーションがS3から録音ファイルをダウンロード
2. OpenAI Whisper APIに送信
3. OpenAI Whisperが文字起こし結果を返す
4. Actoryアプリケーションが文字起こし結果をTursoデータベースに保存

### IndexedDB（ローカルストレージ）

**IndexedDBは、S3が使えない時の「予備の倉庫」**です。

- **S3**: メインの倉庫（インターネット上）
- **IndexedDB**: 予備の倉庫（あなたのパソコンの中）

もしS3の設定がされていない場合、ActoryアプリケーションはIndexedDBに録音ファイルを保存します。ただし、IndexedDBは：
- **容量が限られている**: パソコンの容量に依存
- **他のデバイスからアクセスできない**: このパソコンでしか見られない

### FFmpeg.wasm（音声変換ツール）

**FFmpeg.wasmは、録音ファイルの「形式を統一するツール」**です。

- **問題**: ブラウザによって録音ファイルの形式が異なる（ChromeはWebM、SafariはMP4など）
- **解決**: FFmpeg.wasmが、すべての録音ファイルを統一された形式（例：WAV）に変換

S3にアップロードする前に、FFmpeg.wasmで形式を統一することで、後で処理する時（文字起こしなど）に問題が起きにくくなります。

---

## 📊 全体の流れ図

```
[ユーザーが録音]
    ↓
[ブラウザで録音データを取得]
    ↓
[FFmpeg.wasmで形式を統一] ← 必要に応じて
    ↓
[Actoryアプリケーション（Next.js）]
    ↓
[S3倉庫にアップロード] ← .env.localのアクセスキーを使用
    ↓
[Tursoデータベースに記録] ← 「S3のこの場所に保存されています」という情報
    ↓
[OpenAI Whisperで文字起こし] ← S3からダウンロードして処理
    ↓
[Tursoデータベースに文字起こし結果を保存]
    ↓
[ユーザーが録音を再生] ← TursoからS3の場所を取得 → S3からダウンロード
```

---

## 🎓 用語集（もっと詳しく）

### S3（Simple Storage Service）
- **正式名称**: Amazon Simple Storage Service
- **意味**: インターネット上でファイルを保存・取得できるサービス
- **例え**: 巨大な倉庫

### バケット（Bucket）
- **意味**: S3内のファイルを整理するためのコンテナ
- **例え**: 倉庫の中の整理箱
- **制限**: 1つのAWSアカウントで最大100個まで作成可能（制限緩和申請で増やせる）

### オブジェクト（Object）
- **意味**: S3に保存される個々のファイル
- **例え**: 整理箱の中に入っている1つ1つのアイテム
- **制限**: 1つのオブジェクトは最大5TBまで

### アクセスキーID（Access Key ID）
- **意味**: S3にアクセスするための識別子
- **例え**: 倉庫の鍵の番号
- **形式**: 20文字の英数字（例：AKIAIOSFODNN7EXAMPLE）

### シークレットアクセスキー（Secret Access Key）
- **意味**: S3にアクセスするための秘密鍵
- **例え**: 倉庫を開けるための実際の鍵
- **形式**: 40文字の英数字（例：wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY）

### リージョン（Region）
- **意味**: S3倉庫が物理的に存在する場所
- **例え**: 倉庫の所在地
- **例**: ap-northeast-1（東京）、ap-southeast-2（シドニー）、us-east-1（バージニア）

### IAM（Identity and Access Management）
- **意味**: AWSのセキュリティ管理システム
- **例え**: 倉庫のセキュリティ管理システム
- **役割**: 誰が何にアクセスできるかを管理

### IAMユーザー（IAM User）
- **意味**: IAMで作成される、特定の権限を持つアカウント
- **例え**: 倉庫にアクセスできる「人」のアカウント
- **用途**: Actoryアプリケーション専用のアカウントを作成

### IAMポリシー（IAM Policy）
- **意味**: IAMユーザーに与える権限のルール
- **例え**: 「この人は録音ファイルをアップロードできるが、削除はできない」などのルール
- **形式**: JSON形式で記述

### プリサインドURL（Presigned URL）
- **意味**: 一時的にS3にアクセスできるURL
- **例え**: 期限付きの入場券
- **用途**: ActoryアプリケーションがS3にファイルをアップロードする時、このURLを使う

### .env.local
- **意味**: 環境変数を保存するファイル
- **例え**: Actoryアプリケーションの設定メモ
- **注意**: このファイルはGitにコミットしない（.gitignoreに追加）

---

## 🚀 次のステップ

S3の設定方法については、`docs/s3-setup.md`を参照してください。

---

## ❓ よくある質問

### Q: S3を使わないと、Actoryアプリケーションは動かないの？

A: いいえ。S3が設定されていない場合、ActoryアプリケーションはIndexedDB（ローカルストレージ）に録音ファイルを保存します。ただし、IndexedDBは：
- 容量が限られている
- 他のデバイスからアクセスできない
- パソコンを初期化すると消える

### Q: S3の料金はいくら？

A: S3の料金は、使用量に応じて課金されます。目安：
- **ストレージ**: 1GBあたり約$0.023/月（東京リージョン）
- **アップロード**: 1GBあたり約$0.09
- **ダウンロード**: 1GBあたり約$0.09

例：1時間の録音（約50MB）を100個保存した場合：
- ストレージ: 5GB × $0.023 = 約$0.12/月
- アップロード: 5GB × $0.09 = 約$0.45（初回のみ）

### Q: アクセスキーが漏れたらどうなる？

A: アクセスキーが漏れた場合、悪意のある人があなたのS3倉庫にアクセスできる可能性があります。そのため：
1. **すぐにアクセスキーを無効化する**
2. **新しいアクセスキーを発行する**
3. **.env.localファイルを更新する**

### Q: バケット名は何でもいいの？

A: いいえ。バケット名には制限があります：
- 3〜63文字
- 小文字の英数字とハイフン（-）のみ
- グローバルで一意（世界中で同じ名前は使えない）

例：`actory-recordings`、`my-actory-bucket-2024`など

---

## 📚 関連ドキュメント

- `docs/s3-setup.md`: S3の設定手順（詳細版）
- `docs/s3-setup-simple.md`: S3の設定手順（簡易版）
- `docs/requirements.md`: Actoryアプリケーションの要件定義

---

**このガイドが役に立ったら、ぜひフィードバックをお願いします！**


